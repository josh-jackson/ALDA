


<div id="polynomial-and-splines" class="section level1">
<h1>Polynomial and Splines</h1>
<p>##Polynomaials
level 1:
<span class="math display">\[ {Y}_{ij} = \beta_{0j}  + \beta_{1j}(Time_{ij} - \bar{X)} + \beta_{2j}(Time_{ij} - \bar{X)}^2 + \varepsilon_{ij} \]</span></p>
<p>Level 2:
<span class="math display">\[ {\beta}_{0j} = \gamma_{00} +   U_{0j}\]</span><br />
<span class="math display">\[ {\beta}_{1j} = \gamma_{10} +  U_{1j} \]</span>
<span class="math display">\[ {\beta}_{2j} = \gamma_{20} +  U_{2j} \]</span></p>
<div id="polynomial-example" class="section level2">
<h2>polynomial example</h2>
<pre class="r"><code>rm(list = ls())

library(readr)
cdrs &lt;- read_csv(&quot;~/Box/5165 Applied Longitudinal Data Analysis/Longitudinal/cdrs.csv&quot;)</code></pre>
<pre><code>## Parsed with column specification:
## cols(
##   mapid = col_double(),
##   exclude = col_character(),
##   cdr = col_double(),
##   testdate = col_double()
## )</code></pre>
<pre class="r"><code>personality &lt;- read_csv(&quot;~/Box/5165 Applied Longitudinal Data Analysis/Longitudinal/Subject_personality.csv&quot;)</code></pre>
<pre><code>## Parsed with column specification:
## cols(
##   mapid = col_double(),
##   age = col_double(),
##   neodate = col_double(),
##   neuroticism = col_double(),
##   extraversion = col_double(),
##   openness = col_double(),
##   agreeablness = col_double(),
##   conscientiousness = col_double(),
##   gender = col_character()
## )</code></pre>
<pre class="r"><code>library(ggplot2) 


gg1 &lt;- ggplot(personality,
   aes(x = neodate, y = neuroticism, group = mapid)) + geom_line()  
gg1</code></pre>
<pre><code>## Warning: Removed 1 rows containing missing values (geom_path).</code></pre>
<p><img src="/Lectures/05-poly-splines_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
<pre class="r"><code>library(tidyverse) </code></pre>
<pre><code>## ── Attaching packages ─────────────────────────────── tidyverse 1.2.1.9000 ──</code></pre>
<pre><code>## ✔ tibble  2.1.3           ✔ dplyr   0.8.3      
## ✔ tidyr   0.8.99.9000     ✔ stringr 1.4.0      
## ✔ purrr   0.3.2           ✔ forcats 0.4.0</code></pre>
<pre><code>## ── Conflicts ─────────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()</code></pre>
<pre class="r"><code>personality&lt;- personality %&gt;% 
  group_by(mapid) %&gt;%
  arrange(neodate) %&gt;% 
  mutate(wave = seq_len(n())) </code></pre>
<pre class="r"><code>gg2 &lt;- ggplot(personality,
   aes(x = wave, y = neuroticism, group = mapid)) + geom_line()  
gg2</code></pre>
<p><img src="/Lectures/05-poly-splines_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<pre class="r"><code>personality$neodate &lt;- as.Date(personality$neodate, origin = &quot;1900-01-01&quot;)

gg3 &lt;- ggplot(personality,
   aes(x = neodate, y = neuroticism, group = mapid)) + geom_line()  
gg3</code></pre>
<pre><code>## Warning: Removed 1 rows containing missing values (geom_path).</code></pre>
<p><img src="/Lectures/05-poly-splines_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<pre class="r"><code>## convert to days from first assessment

personality.wide &lt;- personality %&gt;% 
  dplyr::select(mapid, wave, neodate) %&gt;% 
  spread(wave, neodate) 

personality.wide$wave_1 &lt;- personality.wide$&#39;1&#39;
personality.wide$wave_2 &lt;- personality.wide$&#39;2&#39;
personality.wide$wave_3 &lt;- personality.wide$&#39;3&#39;
personality.wide$wave_4 &lt;- personality.wide$&#39;4&#39;
personality.wide$wave_5 &lt;- personality.wide$&#39;5&#39;

personality.wide &lt;- personality.wide %&gt;% 
mutate (w_1 = (wave_1 - wave_1)/365,
          w_2 = (wave_2 - wave_1)/365,
          w_3 = (wave_3 - wave_1)/365,
          w_4 = (wave_4 - wave_1)/365,
        w_5 = (wave_5 - wave_1)/365)

personality.long &lt;- personality.wide %&gt;% 
  dplyr::select(mapid, w_1:w_5) %&gt;% 
  gather(wave, year, -mapid) %&gt;% 
  separate(wave, c(&#39;weeks&#39;, &#39;wave&#39; ), sep=&quot;_&quot;) %&gt;% 
 dplyr::select(-weeks) 

personality.long$wave &lt;-  as.numeric(personality.long$wave)


personality &lt;- personality %&gt;% 
   left_join(personality.long, by = c(&#39;mapid&#39;, &#39;wave&#39; )) </code></pre>
<pre class="r"><code>gg4 &lt;- ggplot(personality,
   aes(x = year, y = neuroticism, group = mapid)) + geom_line()  
gg4</code></pre>
<pre><code>## Don&#39;t know how to automatically pick scale for object of type difftime. Defaulting to continuous.</code></pre>
<pre><code>## Warning: Removed 1 rows containing missing values (geom_path).</code></pre>
<p><img src="/Lectures/05-poly-splines_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<pre class="r"><code>library(lme4)</code></pre>
<pre><code>## Loading required package: Matrix</code></pre>
<pre><code>## 
## Attaching package: &#39;Matrix&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:tidyr&#39;:
## 
##     expand, pack, unpack</code></pre>
<pre class="r"><code>p1 &lt;- lmer(neuroticism ~ year + (1 | mapid), data=personality)
summary(p1)</code></pre>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: neuroticism ~ year + (1 | mapid)
##    Data: personality
## 
## REML criterion at convergence: 13657.4
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -2.7877 -0.4675 -0.0227  0.4289  3.3166 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  mapid    (Intercept) 42.16    6.493   
##  Residual             15.65    3.956   
## Number of obs: 2105, groups:  mapid, 1090
## 
## Fixed effects:
##             Estimate Std. Error t value
## (Intercept) 16.05632    0.22577  71.118
## year        -0.13204    0.03247  -4.067
## 
## Correlation of Fixed Effects:
##      (Intr)
## year -0.247</code></pre>
<pre class="r"><code>library(lme4)
personality.s &lt;- personality %&gt;% 
  group_by(mapid) %&gt;% 
  tally() %&gt;% 
   filter(n &gt;=2) 

 personality &lt;- personality %&gt;% 
   filter(mapid %in% personality.s$mapid)

p2 &lt;- lmer(neuroticism ~ year + (1 | mapid), data=personality)
summary(p2)</code></pre>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: neuroticism ~ year + (1 | mapid)
##    Data: personality
## 
## REML criterion at convergence: 10396.9
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -2.7542 -0.5122 -0.0282  0.4698  3.3369 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  mapid    (Intercept) 40.92    6.397   
##  Residual             15.61    3.950   
## Number of obs: 1635, groups:  mapid, 620
## 
## Fixed effects:
##             Estimate Std. Error t value
## (Intercept)  15.3797     0.2915  52.761
## year         -0.1083     0.0331  -3.271
## 
## Correlation of Fixed Effects:
##      (Intr)
## year -0.320</code></pre>
<pre class="r"><code>p3 &lt;- lmer(neuroticism ~ year + (year | mapid), data=personality)
summary(p3)</code></pre>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: neuroticism ~ year + (year | mapid)
##    Data: personality
## 
## REML criterion at convergence: 10389.2
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -2.7440 -0.4825 -0.0304  0.4443  3.3453 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev. Corr 
##  mapid    (Intercept) 41.6916  6.4569        
##           year         0.0983  0.3135   -0.10
##  Residual             14.2561  3.7757        
## Number of obs: 1635, groups:  mapid, 620
## 
## Fixed effects:
##             Estimate Std. Error t value
## (Intercept) 15.37237    0.29136  52.760
## year        -0.10271    0.03602  -2.851
## 
## Correlation of Fixed Effects:
##      (Intr)
## year -0.317</code></pre>
<div id="importance-of-centering" class="section level3">
<h3>importance of centering</h3>
<pre class="r"><code>personality$year &lt;- as.numeric(personality$year)
  
p4 &lt;- lmer(neuroticism ~ year + I(year^2) + (year | mapid), data=personality)</code></pre>
<pre><code>## Warning in checkConv(attr(opt, &quot;derivs&quot;), opt$par, ctrl =
## control$checkConv, : Model failed to converge with max|grad| = 0.00216391
## (tol = 0.002, component 1)</code></pre>
<pre class="r"><code>summary(p4)</code></pre>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: neuroticism ~ year + I(year^2) + (year | mapid)
##    Data: personality
## 
## REML criterion at convergence: 10395.8
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -2.7664 -0.4836 -0.0251  0.4422  3.3259 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev. Corr 
##  mapid    (Intercept) 41.73017 6.4599        
##           year         0.09818 0.3133   -0.10
##  Residual             14.26174 3.7765        
## Number of obs: 1635, groups:  mapid, 620
## 
## Fixed effects:
##              Estimate Std. Error t value
## (Intercept) 15.324317   0.297096  51.580
## year        -0.031791   0.092090  -0.345
## I(year^2)   -0.008789   0.010490  -0.838
## 
## Correlation of Fixed Effects:
##           (Intr) year  
## year      -0.300       
## I(year^2)  0.194 -0.920
## convergence code: 0
## Model failed to converge with max|grad| = 0.00216391 (tol = 0.002, component 1)</code></pre>
<pre class="r"><code># woah, how do I interpret this? WHy all of a sudden non-sig? 
# what would happen if I changed my time metric? </code></pre>
<pre class="r"><code>library(psych)</code></pre>
<pre><code>## 
## Attaching package: &#39;psych&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:ggplot2&#39;:
## 
##     %+%, alpha</code></pre>
<pre class="r"><code>describe(personality$year)</code></pre>
<pre><code>##    vars    n mean   sd median trimmed  mad min   max range skew kurtosis
## X1    1 1635  3.1 3.29   2.45    2.66 3.63   0 12.78 12.78  0.8    -0.41
##      se
## X1 0.08</code></pre>
<pre class="r"><code>personality$year.c &lt;- personality$year - 3.1

p5 &lt;- lmer(neuroticism ~ year.c + I(year.c^2) + (year.c | mapid), data=personality)
summary(p5)</code></pre>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: neuroticism ~ year.c + I(year.c^2) + (year.c | mapid)
##    Data: personality
## 
## REML criterion at convergence: 10395.8
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -2.7663 -0.4836 -0.0251  0.4422  3.3258 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev. Corr
##  mapid    (Intercept) 41.42901 6.4365       
##           year.c       0.09812 0.3132   0.05
##  Residual             14.26278 3.7766       
## Number of obs: 1635, groups:  mapid, 620
## 
## Fixed effects:
##              Estimate Std. Error t value
## (Intercept) 15.141297   0.296070  51.141
## year.c      -0.086286   0.041061  -2.101
## I(year.c^2) -0.008789   0.010490  -0.838
## 
## Correlation of Fixed Effects:
##             (Intr) year.c
## year.c       0.226       
## I(year.c^2) -0.353 -0.480</code></pre>
</div>
<div id="random-terms" class="section level3">
<h3>random terms</h3>
<p>fitting a random slope plus a random quadratic leads to difficulties ie non-congergence. What does this model say?</p>
<pre class="r"><code>p6 &lt;- lmer(neuroticism ~ year + I(year^2) + ( I(year^2) | mapid), data=personality)</code></pre>
<pre><code>## Warning in checkConv(attr(opt, &quot;derivs&quot;), opt$par, ctrl =
## control$checkConv, : Model failed to converge with max|grad| = 0.167875
## (tol = 0.002, component 1)</code></pre>
<pre><code>## Warning in checkConv(attr(opt, &quot;derivs&quot;), opt$par, ctrl = control$checkConv, : Model is nearly unidentifiable: very large eigenvalue
##  - Rescale variables?</code></pre>
<pre class="r"><code>summary(p6)</code></pre>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: neuroticism ~ year + I(year^2) + (I(year^2) | mapid)
##    Data: personality
## 
## REML criterion at convergence: 10398.9
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -2.7747 -0.4937 -0.0197  0.4525  3.3481 
## 
## Random effects:
##  Groups   Name        Variance  Std.Dev. Corr
##  mapid    (Intercept) 4.082e+01 6.38890      
##           I(year^2)   4.851e-04 0.02203  0.02
##  Residual             1.505e+01 3.87965      
## Number of obs: 1635, groups:  mapid, 620
## 
## Fixed effects:
##              Estimate Std. Error t value
## (Intercept) 15.321498   0.296523  51.670
## year        -0.026955   0.093386  -0.289
## I(year^2)   -0.009488   0.010729  -0.884
## 
## Correlation of Fixed Effects:
##           (Intr) year  
## year      -0.300       
## I(year^2)  0.202 -0.928
## convergence code: 0
## Model failed to converge with max|grad| = 0.167875 (tol = 0.002, component 1)
## Model is nearly unidentifiable: very large eigenvalue
##  - Rescale variables?</code></pre>
</div>
</div>
<div id="splines-aka-piecewise" class="section level2">
<h2>Splines aka piecewise</h2>
<p>Fit more than 1 trajectory. Best to use when we have a reason for a qualitative difference at some identified time point. For example, before your health event you may have a different trajectory than after it and thus you would want to model two seperate trajectories. Splines allow you to do this in a single model. You can do this in simple regression and the logic follows for growth models.</p>
<p>We simply replace time with dummy variables that represent different segments we wish to model. The point of separation is called a knot. You can have as many as you want and these can be pre-specified (usually for our case) or in more advanced treatments have the data specify it for you.</p>
<div id="seperate-curves" class="section level3">
<h3>seperate curves</h3>
<p>The most common is to create different trajectories that change across knots. The easiest example is to take your time variable and transform it into a Time1 and time2, that represent the different time periods. This is easiest to see if we choose our wave variable as our time metric, though you do not have to necessarily do it this way.</p>
<pre class="r"><code>t1 &lt;- tribble(
  ~time, ~t0, ~t1,~t2,~t3,~t4,~t5,
  &quot;time 1&quot;, 0, 1,2,2,2,2,
  &quot;time 2&quot;, 0, 0,0,1,2,3
)
t1</code></pre>
<pre><code>## # A tibble: 2 x 7
##   time      t0    t1    t2    t3    t4    t5
##   &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 time 1     0     1     2     2     2     2
## 2 time 2     0     0     0     1     2     3</code></pre>
<p>The idea is that once you hit the knot your value stays the same. Same logic for the second knot, until you get to that knot you dont have a trajectory.</p>
<p>###incremental curves
This can be contrasted with a different type of coding, called incremental. Here the first trajectory keeps going, whereas the second trajectory starts at the position of the knot.</p>
<pre class="r"><code>t2 &lt;- tribble(
  ~time, ~t0, ~t1,~t2,~t3,~t4,~t5,
  &quot;time 1&quot;, 0, 1,2,3,4,5,
  &quot;time 2&quot;, 0, 0,0,1,2,3
)
t2</code></pre>
<pre><code>## # A tibble: 2 x 7
##   time      t0    t1    t2    t3    t4    t5
##   &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 time 1     0     1     2     3     4     5
## 2 time 2     0     0     0     1     2     3</code></pre>
<p>The two coding schemes propose the same type of trajectoy, the only thing that differes is the interpretation of the coefficients.</p>
<p>In the first, the two slope coefficients represent the actual slope in the respective time period.</p>
<p>In the second, the coefficient for time 2 represents the deviation from the slope in period 1. The positive of this second method is you can easily test whether these two slopes are different from one another.</p>
<p>level 1:</p>
<p><span class="math display">\[ {Y}_{ij} = \beta_{0j}  + \beta_{1j}Time1_{ij} + \beta_{2j}Time2_{ij} + \varepsilon_{ij} \]</span></p>
<p>Level 2:
<span class="math display">\[ {\beta}_{0j} = \gamma_{00} +  U_{0j} \]</span></p>
<p><span class="math display">\[ {\beta}_{1j} = \gamma_{10} +  U_{1j} \]</span>
<span class="math display">\[ {\beta}_{2j} = \gamma_{20} +  U_{2j} \]</span></p>
<p>###splines example</p>
<pre class="r"><code>personality$time1 &lt;- recode(personality$wave, &#39;1&#39; = 0 , &#39;2&#39; = 1,  &#39;3&#39; = 1, &#39;4&#39; = 1,&#39;5&#39; = 1)      
personality$time2 &lt;- recode(personality$wave, &#39;1&#39; = 0 , &#39;2&#39; = 0,  &#39;3&#39; = 1, &#39;4&#39; = 2,&#39;5&#39; = 3) </code></pre>
<pre class="r"><code>p7 &lt;- lmer(conscientiousness ~ time1 + time2 + (time1   | mapid) , data=personality)
summary(p7)</code></pre>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: conscientiousness ~ time1 + time2 + (time1 | mapid)
##    Data: personality
## 
## REML criterion at convergence: 10003.8
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -5.2558 -0.4068  0.0272  0.4304  4.5854 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev. Corr 
##  mapid    (Intercept) 32.979   5.743         
##           time1        4.729   2.175    -0.13
##  Residual             10.702   3.271         
## Number of obs: 1635, groups:  mapid, 620
## 
## Fixed effects:
##             Estimate Std. Error t value
## (Intercept)  34.1871     0.2654 128.800
## time1        -0.5365     0.2018  -2.658
## time2         0.2184     0.1561   1.399
## 
## Correlation of Fixed Effects:
##       (Intr) time1 
## time1 -0.370       
## time2  0.000 -0.301</code></pre>
<pre class="r"><code>gg5 &lt;- ggplot(personality, aes(x = wave, y = conscientiousness, group = mapid)) +  stat_smooth(method = &#39;lm&#39;, formula = y ~ poly(x,2, raw = TRUE),data = personality, aes(x = wave, y = conscientiousness, group=1)) + scale_y_continuous(limits = c(30, 40))
gg5</code></pre>
<pre><code>## Warning: Removed 609 rows containing non-finite values (stat_smooth).</code></pre>
<p><img src="/Lectures/05-poly-splines_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
</div>
</div>
<div id="splines-polynomail-polynomial-piecewise" class="section level2">
<h2>splines + polynomail = polynomial piecewise</h2>
<p><span class="math display">\[ {Y}_{ij} = \beta_{0j}  + \beta_{1j}Time1_{ij} +  \beta_{2j}Time1_{ij}^2 + \beta_{3j}Time2_{ij} + \varepsilon_{ij} \]</span></p>
<p>Level 2:
<span class="math display">\[ {\beta}_{0j} = \gamma_{00} +  U_{0j} \]</span></p>
<p><span class="math display">\[ {\beta}_{1j} = \gamma_{10} +  U_{1j} \]</span>
<span class="math display">\[ {\beta}_{2j} = \gamma_{20} +  U_{2j} \]</span>
<span class="math display">\[ {\beta}_{3j} = \gamma_{30} +  U_{3j}\]</span></p>
</div>
</div>
